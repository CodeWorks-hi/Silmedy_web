{% extends "base.html" %}
{% block content %}
<h2 style="margin-bottom: 20px;">ë¹„ëŒ€ë©´ ì§„ë£Œ</h2>

<!-- ì „ì²´ êµ¬ì¡°: ì¢Œ(ì§„ë£Œ ì…ë ¥) + ìš°(ì˜ìƒ) -->
<div style="display: flex; gap: 40px; align-items: flex-start;">
  
  <!-- ğŸ“‹ ì¢Œì¸¡ íŒ¨ë„: ì§„ë£Œ ì •ë³´ -->
  <section style="flex: 2; display: flex; flex-direction: column; gap: 20px;">
    
    <!-- í™˜ì ì •ë³´ -->
    <div style="background:#f9f9f9; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <h3>í™˜ì ì •ë³´</h3>
      ì´ë¦„: {{ patient.name }}<br>
      ìƒë…„ì›”ì¼: {{ patient.birth }}<br>
      ì„±ë³„: {{ patient.gender }}<br>
      ì¦ìƒ ë¶€ìœ„: {{ patient.symptom_area }}<br>
      ì£¼ìš” ì¦ìƒ: {{ patient.main_symptom }}
    </div>

    <!-- ë³‘ëª… ì…ë ¥ -->
    <div style="background:#fff; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <label><strong>ë³‘ëª…:</strong></label><br>
      <input name="disease_code" placeholder="ê²€ìƒ‰ ë˜ëŠ” ì„ íƒ" style="width: 100%; padding: 6px;">
      <p style="margin-top: 6px;">ë³´í—˜ ë¶„ë¥˜: <span id="insurance_type">ìë™ ë¡œë”©</span></p>
    </div>

    <!-- ì²˜ë°© ì…ë ¥ -->
    <div style="background:#fff; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <label><strong>ì²˜ë°© ì•½í’ˆ:</strong></label><br>
      <input name="medication_code" placeholder="ì•½í’ˆ ê²€ìƒ‰" style="width: 100%; padding: 6px;">
      <br><br>
      <label><strong>íˆ¬ì•½ ì¼ìˆ˜:</strong></label><br>
      <input name="days" type="number" min="1" style="width: 100%; padding: 6px;">
      <br><br>
      <button type="button" id="add-prescription-btn" style="padding: 8px 16px; background:#4db6ac; color:white; border:none; border-radius:4px;">ë“±ë¡</button>
    </div>

    <!-- ë“±ë¡ëœ ì²˜ë°© ë¦¬ìŠ¤íŠ¸ -->
    <div id="prescription-list" style="background:#f6f6f6; padding: 16px; border-radius: 8px;">
      <strong>ë“±ë¡ëœ ì²˜ë°©:</strong>
      <div id="prescription-items"></div>
    </div>

    <!-- ì§„ë£Œì´ë ¥ -->
    <div style="background:#f2f2f2; padding: 16px; border-radius: 8px;">
      <h3>ì§„ë£Œ ì´ë ¥</h3>
      ë§ˆì§€ë§‰ ì§„ë£Œì¼: {{ consultation.previous_date or "ì—†ìŒ" }}<br>
      ì´ì „ ë³‘ëª… ì½”ë“œ: {{ consultation.previous_disease_code or "ì—†ìŒ" }}
    </div>

    <!-- ë©”ëª¨ -->
    <div>
      <label><strong>ì§„ë£Œ ë©”ëª¨</strong></label><br>
      <textarea name="memo" rows="4" style="width:100%; padding:8px;"></textarea>
    </div>

    <!-- ë²„íŠ¼ë“¤ -->
    <div style="display:flex; gap: 20px; margin-top: 10px;">
      <form method="post" action="/prescription/submit">
        <input type="hidden" name="patient_id" value="{{ consultation.patient_id }}">
        <input type="hidden" name="doctor_id" value="{{ consultation.doctor_id }}">
        <button type="submit" style="padding:10px 20px; background:#388e3c; color:white; border:none; border-radius:6px;">ì²˜ë°©ì „ ì „ì†¡</button>
      </form>
      <a href="/doctor/consultation" style="padding:10px 20px; background:#aaa; color:white; border-radius:6px; text-decoration:none;">ì§„ë£Œ ì¢…ë£Œ</a>
    </div>

  </section>

    <!-- ğŸ¥ ìš°ì¸¡ íŒ¨ë„: ì˜ìƒ -->
    <section style="flex: 1; position: sticky; top: 40px; align-self: flex-start;">
    <video id="localVideo" autoplay muted playsinline style="width:100%; border-radius:10px; border:1px solid #ccc;"></video>
    <video id="remoteVideo" autoplay playsinline style="position:absolute; top:10px; right:10px; width:120px; height:auto; border: 2px solid #fff;"></video>
    <p style="margin-top:10px; text-align:center;">ì˜ìƒ ì—°ê²° ì¤‘...</p>
    </section>

<!-- ë“±ë¡ëœ ì²˜ë°© ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  const prescriptions = [];

  document.getElementById("add-prescription-btn").addEventListener("click", () => {
    const med = document.querySelector('input[name="medication_code"]').value.trim();
    const days = document.querySelector('input[name="days"]').value.trim();
    const disease = document.querySelector('input[name="disease_code"]').value.trim();

    if (!med || !days || !disease) {
      alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    prescriptions.push({ medication_code: med, days: days, disease_code: disease });
    renderPrescriptions();
  });

  function renderPrescriptions() {
    const container = document.getElementById("prescription-items");
    container.innerHTML = "";

    prescriptions.forEach((item, idx) => {
      const card = document.createElement("div");
      card.style = "padding: 8px; margin: 8px 0; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1)";
      card.innerHTML = `
        <strong>ì•½í’ˆ:</strong> ${item.medication_code} |
        <strong>íˆ¬ì•½ì¼ìˆ˜:</strong> ${item.days}ì¼ |
        <strong>ë³‘ëª…:</strong> ${item.disease_code}
      `;
      container.appendChild(card);
    });
  }
</script>
{% endblock %}