{% extends "base.html" %}
{% block content %}
<h2 style="margin-bottom: 20px;">비대면 진료</h2>

<!-- 전체 구조: 좌(진료 입력) + 우(영상) -->
<div style="display: flex; gap: 40px; align-items: flex-start;">
  
  <!-- 📋 좌측 패널: 진료 정보 -->
  <section style="flex: 2; display: flex; flex-direction: column; gap: 20px;">
    
    <!-- 환자 정보 -->
    <div style="background:#f9f9f9; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <h3>환자 정보</h3>
      이름: {{ patient.name }}<br>
      생년월일: {{ patient.birth }}<br>
      성별: {{ patient.gender }}<br>
      증상 부위: {{ patient.symptom_area }}<br>
      주요 증상: {{ patient.main_symptom }}
    </div>

    <!-- 병명 입력 -->
    <div style="background:#fff; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <label><strong>병명:</strong></label><br>
      <input name="disease_code" placeholder="검색 또는 선택" style="width: 100%; padding: 6px;">
      <p style="margin-top: 6px;">보험 분류: <span id="insurance_type">자동 로딩</span></p>
    </div>

    <!-- 처방 입력 -->
    <div style="background:#fff; border:1px solid #ccc; padding: 16px; border-radius: 10px;">
      <label><strong>처방 약품:</strong></label><br>
      <input name="medication_code" placeholder="약품 검색" style="width: 100%; padding: 6px;">
      <br><br>
      <label><strong>투약 일수:</strong></label><br>
      <input name="days" type="number" min="1" style="width: 100%; padding: 6px;">
      <br><br>
      <button type="button" id="add-prescription-btn" style="padding: 8px 16px; background:#4db6ac; color:white; border:none; border-radius:4px;">등록</button>
    </div>

    <!-- 등록된 처방 리스트 -->
    <div id="prescription-list" style="background:#f6f6f6; padding: 16px; border-radius: 8px;">
      <strong>등록된 처방:</strong>
      <div id="prescription-items"></div>
    </div>

    <!-- 진료이력 -->
    <div style="background:#f2f2f2; padding: 16px; border-radius: 8px;">
      <h3>진료 이력</h3>
      마지막 진료일: {{ consultation.previous_date or "없음" }}<br>
      이전 병명 코드: {{ consultation.previous_disease_code or "없음" }}
    </div>

    <!-- 메모 -->
    <div>
      <label><strong>진료 메모</strong></label><br>
      <textarea name="memo" rows="4" style="width:100%; padding:8px;"></textarea>
    </div>

    <!-- 버튼들 -->
    <div style="display:flex; gap: 20px; margin-top: 10px;">
      <form method="post" action="/prescription/submit">
        <input type="hidden" name="patient_id" value="{{ consultation.patient_id }}">
        <input type="hidden" name="doctor_id" value="{{ consultation.doctor_id }}">
        <button type="submit" style="padding:10px 20px; background:#388e3c; color:white; border:none; border-radius:6px;">처방전 전송</button>
      </form>
      <a href="/doctor/consultation" style="padding:10px 20px; background:#aaa; color:white; border-radius:6px; text-decoration:none;">진료 종료</a>
    </div>

  </section>

    <!-- 🎥 우측 패널: 영상 -->
    <section style="flex: 1; position: sticky; top: 40px; align-self: flex-start;">
    <video id="localVideo" autoplay muted playsinline style="width:100%; border-radius:10px; border:1px solid #ccc;"></video>
    <video id="remoteVideo" autoplay playsinline style="position:absolute; top:10px; right:10px; width:120px; height:auto; border: 2px solid #fff;"></video>
    <p style="margin-top:10px; text-align:center;">영상 연결 중...</p>
    </section>

<!-- 등록된 처방 리스트 추가 스크립트 -->
<script>
  const prescriptions = [];

  document.getElementById("add-prescription-btn").addEventListener("click", () => {
    const med = document.querySelector('input[name="medication_code"]').value.trim();
    const days = document.querySelector('input[name="days"]').value.trim();
    const disease = document.querySelector('input[name="disease_code"]').value.trim();

    if (!med || !days || !disease) {
      alert("모든 항목을 입력하세요");
      return;
    }

    prescriptions.push({ medication_code: med, days: days, disease_code: disease });
    renderPrescriptions();
  });

  function renderPrescriptions() {
    const container = document.getElementById("prescription-items");
    container.innerHTML = "";

    prescriptions.forEach((item, idx) => {
      const card = document.createElement("div");
      card.style = "padding: 8px; margin: 8px 0; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1)";
      card.innerHTML = `
        <strong>약품:</strong> ${item.medication_code} |
        <strong>투약일수:</strong> ${item.days}일 |
        <strong>병명:</strong> ${item.disease_code}
      `;
      container.appendChild(card);
    });
  }
</script>
{% endblock %}